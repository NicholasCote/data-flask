<!DOCTYPE html>
<html>
    <title>Home | NSF NCAR Stratus & GLADE UI</title>
        <link rel="canonical" href="{% url 'home' %}"/>
        <meta property="og:title" content="Home | NCAR Stratus UI"/>
        <meta property="og:url" content="{% url 'home' %}"/>
        <meta property="og:site_name" content="ncar_stratus_ui"/>
        <meta property="og:type" content="website"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}
    <link rel="stylesheet" href="{% static 'style.css' %}" type="text/css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/e08b5a6906.js" crossorigin="anonymous"></script>
    <body>
        <div id="nav">
            {% include 'navbar.html' %}
        </div>
        <div class="container mt-5">
            <h2>NYC Taxi Data Analysis</h2>
            <div class="row mb-4">
                <div class="col-md-3">
                    <button id="analyzeBtn" class="btn btn-primary btn-block">Basic Taxi Analysis</button>
                </div>
                <div class="col-md-3">
                    <button id="maxAnalyzeBtn" class="btn btn-primary btn-block">Max Fare Analysis</button>
                </div>
                <div class="col-md-3">
                    <button id="sumAnalyzeBtn" class="btn btn-primary btn-block">Total Fare Analysis</button>
                </div>
                <div class="col-md-3">
                    <button id="weatherAnalyzeBtn" class="btn btn-info btn-block">
                        <i class="fas fa-cloud-sun-rain"></i> Weather Impact Analysis
                    </button>
                </div>
            </div>
            
            <div class="alert alert-warning" id="weatherWarning" style="display: none;">
                <strong>Note:</strong> Weather analysis is computationally intensive and may take several minutes to complete. You can still use other features while waiting.
            </div>
            
            <!-- Active Analysis Section -->
            <div class="mt-4">
                <h3>Active Analysis Tasks</h3>
                
                <!-- Progress bars for each analysis type -->
                <div id="basicAnalysisProgress" style="display: none;" class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Basic Taxi Analysis</h5>
                        <div class="progress">
                            <div id="basicProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" 
                                style="width: 0%">0%</div>
                        </div>
                        <p class="text-muted mt-2" id="basicLoadingText">Analysis in progress...</p>
                    </div>
                </div>
                
                <div id="maxAnalysisProgress" style="display: none;" class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Maximum Fare Analysis</h5>
                        <div class="progress">
                            <div id="maxProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" 
                                style="width: 0%">0%</div>
                        </div>
                        <p class="text-muted mt-2" id="maxLoadingText">Analysis in progress...</p>
                    </div>
                </div>
                
                <div id="sumAnalysisProgress" style="display: none;" class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Total Fare Analysis</h5>
                        <div class="progress">
                            <div id="sumProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" 
                                style="width: 0%">0%</div>
                        </div>
                        <p class="text-muted mt-2" id="sumLoadingText">Analysis in progress...</p>
                    </div>
                </div>
                
                <div id="weatherAnalysisProgress" style="display: none;" class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Weather Impact Analysis</h5>
                        <div class="progress">
                            <div id="weatherProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                                role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" 
                                style="width: 0%">0%</div>
                        </div>
                        <p class="text-muted mt-2" id="weatherLoadingText">Analysis in progress (this may take several minutes)...</p>
                    </div>
                </div>
            </div>
            
            <!-- Results Section -->
            <div class="mt-4">
                <h3>Analysis Results</h3>
                
                <!-- Average Analysis Results -->
                <div id="avgResults" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            Basic Taxi Analysis Results
                        </div>
                        <div class="card-body">
                            <p><strong>Average Fare:</strong> $<span id="avgFare"></span></p>
                            <p><strong>Maximum Trip Distance:</strong> <span id="maxDist"></span> Miles</p>
                            <p><strong>Total Passengers:</strong> <span id="totalPass"></span></p>
                        </div>
                    </div>
                </div>
                
                <!-- Maximum Fare Results -->
                <div id="maxResults" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            Maximum Fare Analysis Results
                        </div>
                        <div class="card-body">
                            <p><strong>Maximum Fare:</strong> $<span id="maxFare"></span></p>
                        </div>
                    </div>
                </div>
                
                <!-- Sum Fare Results -->
                <div id="sumResults" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            Total Fare Analysis Results
                        </div>
                        <div class="card-body">
                            <p><strong>Total Fares:</strong> $<span id="sumFare"></span></p>
                        </div>
                    </div>
                </div>
                
                <!-- Weather Analysis Results -->
                <div id="weatherResults" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            Weather Impact Analysis Results
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h4>Analysis Summary</h4>
                                    <p><strong>Total Days Analyzed:</strong> <span id="totalDays"></span></p>
                                    <p><strong>Data Points Collected:</strong> <span id="dataPoints"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <h4>Top Weather Correlations</h4>
                                    <div id="correlationsList"></div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <h4>Weather Impact Samples</h4>
                                <div class="table-responsive">
                                    <table class="table table-striped table-sm" id="weatherSamplesTable">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Hour</th>
                                                <th>Ride Count</th>
                                                <th>Avg Fare</th>
                                                <th>Weather Impact</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Weather sample rows will be added here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
        document.getElementById('analyzeBtn').addEventListener('click', function() {
            const progressDiv = document.getElementById('basicAnalysisProgress');
            const resultsDiv = document.getElementById('avgResults');
            const progressBar = document.getElementById('basicProgressBar');
            const loadingText = document.getElementById('basicLoadingText');
            
            progressDiv.style.display = 'block';
            loadingText.textContent = 'Basic analysis in progress...';
            
            // Reset progress bar
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            
            // Simulate progress for immediate feedback
            let progress = 0;
            let progressInterval = setInterval(() => {
                progress += 5;
                if (progress > 90) {
                    clearInterval(progressInterval);
                } else {
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = progress + '%';
                    progressBar.setAttribute('aria-valuenow', progress);
                }
            }, 200);
            
            fetch('/trigger-analysis/')
                .then(response => response.json())
                .then(data => {
                    checkAverageStatus(data.task_id, progressInterval);
                });
        });
        
        function checkAverageStatus(taskId, progressInterval) {
            fetch(`/check-task/${taskId}/`)
                .then(response => response.json())
                .then(data => {
                    console.log('Task check response:', data);  // Debug print
                    if (data.status === 'SUCCESS') {
                        clearInterval(progressInterval);
                        
                        const progressBar = document.getElementById('basicProgressBar');
                        progressBar.style.width = '100%';
                        progressBar.textContent = 'Complete!';
                        progressBar.setAttribute('aria-valuenow', 100);
                        
                        setTimeout(() => {
                            document.getElementById('basicLoadingText').textContent = 'Analysis complete!';
                            document.getElementById('avgResults').style.display = 'block';
                            
                            // Hide progress after delay (optional)
                            setTimeout(() => {
                                document.getElementById('basicAnalysisProgress').style.display = 'none';
                            }, 3000);
                        }, 500);
                        
                        console.log('Setting values:', {  // Debug print
                            avgFare: data.result.average_fare,
                            maxDist: data.result.max_distance,
                            totalPass: data.result.total_passengers
                        });
                        
                        document.getElementById('avgFare').textContent = data.result.average_fare.toFixed(2);
                        document.getElementById('maxDist').textContent = data.result.max_distance.toFixed(4);
                        document.getElementById('totalPass').textContent = data.result.total_passengers;
                    } else {
                        setTimeout(() => checkAverageStatus(taskId, progressInterval), 1000);
                    }
                })
                .catch(error => {
                    console.error('Error checking status:', error);
                    clearInterval(progressInterval);
                    document.getElementById('basicLoadingText').textContent = 'Error: ' + error.message;
                });
        }
        
        document.getElementById('maxAnalyzeBtn').addEventListener('click', function() {
            const progressDiv = document.getElementById('maxAnalysisProgress');
            const resultsDiv = document.getElementById('maxResults');
            const progressBar = document.getElementById('maxProgressBar');
            const loadingText = document.getElementById('maxLoadingText');
            
            progressDiv.style.display = 'block';
            loadingText.textContent = 'Maximum fare analysis in progress...';
            
            // Reset progress bar
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            
            // Simulate progress for immediate feedback
            let progress = 0;
            let progressInterval = setInterval(() => {
                progress += 5;
                if (progress > 90) {
                    clearInterval(progressInterval);
                } else {
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = progress + '%';
                    progressBar.setAttribute('aria-valuenow', progress);
                }
            }, 200);
            
            fetch('/trigger-max-analysis/')
                .then(response => response.json())
                .then(data => {
                    checkMaxStatus(data.task_id, progressInterval);
                });
        });
        
        function checkMaxStatus(taskId, progressInterval) {
            fetch(`/check-task/${taskId}/`)
                .then(response => response.json())
                .then(data => {
                    console.log('Task check response:', data);  // Debug print
                    if (data.status === 'SUCCESS') {
                        clearInterval(progressInterval);
                        
                        const progressBar = document.getElementById('maxProgressBar');
                        progressBar.style.width = '100%';
                        progressBar.textContent = 'Complete!';
                        progressBar.setAttribute('aria-valuenow', 100);
                        
                        setTimeout(() => {
                            document.getElementById('maxLoadingText').textContent = 'Analysis complete!';
                            document.getElementById('maxResults').style.display = 'block';
                            
                            // Hide progress after delay (optional)
                            setTimeout(() => {
                                document.getElementById('maxAnalysisProgress').style.display = 'none';
                            }, 3000);
                        }, 500);
                        
                        console.log('Setting values:', {  // Debug print
                            maxFare: data.result.maximum_fare
                        });
    
                        document.getElementById('maxFare').textContent = data.result.maximum_fare.toFixed(2);
                    } else {
                        setTimeout(() => checkMaxStatus(taskId, progressInterval), 1000);
                    }
                })
                .catch(error => {
                    console.error('Error checking status:', error);
                    clearInterval(progressInterval);
                    document.getElementById('maxLoadingText').textContent = 'Error: ' + error.message;
                });
        }
        
        document.getElementById('sumAnalyzeBtn').addEventListener('click', function() {
            const progressDiv = document.getElementById('sumAnalysisProgress');
            const resultsDiv = document.getElementById('sumResults');
            const progressBar = document.getElementById('sumProgressBar');
            const loadingText = document.getElementById('sumLoadingText');
            
            progressDiv.style.display = 'block';
            loadingText.textContent = 'Total fare analysis in progress...';
            
            // Reset progress bar
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            
            // Simulate progress for immediate feedback
            let progress = 0;
            let progressInterval = setInterval(() => {
                progress += 5;
                if (progress > 90) {
                    clearInterval(progressInterval);
                } else {
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = progress + '%';
                    progressBar.setAttribute('aria-valuenow', progress);
                }
            }, 200);
            
            fetch('/trigger-sum-analysis/')
                .then(response => response.json())
                .then(data => {
                    checkSumStatus(data.task_id, progressInterval);
                });
        });
        
        function checkSumStatus(taskId, progressInterval) {
            fetch(`/check-task/${taskId}/`)
                .then(response => response.json())
                .then(data => {
                    console.log('Task check response:', data);  // Debug print
                    if (data.status === 'SUCCESS') {
                        clearInterval(progressInterval);
                        
                        const progressBar = document.getElementById('sumProgressBar');
                        progressBar.style.width = '100%';
                        progressBar.textContent = 'Complete!';
                        progressBar.setAttribute('aria-valuenow', 100);
                        
                        setTimeout(() => {
                            document.getElementById('sumLoadingText').textContent = 'Analysis complete!';
                            document.getElementById('sumResults').style.display = 'block';
                            
                            // Hide progress after delay (optional)
                            setTimeout(() => {
                                document.getElementById('sumAnalysisProgress').style.display = 'none';
                            }, 3000);
                        }, 500);
                        
                        console.log('Setting values:', {  // Debug print
                            sumFare: data.result.total_fare
                        });
    
                        document.getElementById('sumFare').textContent = data.result.total_fare.toFixed(2);
                    } else {
                        setTimeout(() => checkSumStatus(taskId, progressInterval), 1000);
                    }
                })
                .catch(error => {
                    console.error('Error checking status:', error);
                    clearInterval(progressInterval);
                    document.getElementById('sumLoadingText').textContent = 'Error: ' + error.message;
                });
        }
        
        document.getElementById('weatherAnalyzeBtn').addEventListener('click', function() {
            const progressDiv = document.getElementById('weatherAnalysisProgress');
            const resultsDiv = document.getElementById('weatherResults');
            const warningDiv = document.getElementById('weatherWarning');
            const progressBar = document.getElementById('weatherProgressBar');
            const loadingText = document.getElementById('weatherLoadingText');
            
            progressDiv.style.display = 'block';
            warningDiv.style.display = 'block';
            loadingText.textContent = 'Weather impact analysis in progress (this may take several minutes)...';
            
            // Reset progress bar
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            
            // Simulate slower progress for the long-running task
            let progress = 0;
            let progressInterval = setInterval(() => {
                // Slower progress increment for long-running task
                let increment = 0.5;
                
                // Slow down progress as it gets higher
                if (progress > 70) increment = 0.1;
                else if (progress > 50) increment = 0.2;
                else if (progress > 30) increment = 0.3;
                
                progress += increment;
                if (progress > 95) {
                    clearInterval(progressInterval);
                    progress = 95;
                }
                
                progressBar.style.width = progress + '%';
                progressBar.textContent = Math.round(progress) + '%';
                progressBar.setAttribute('aria-valuenow', progress);
            }, 300);
            
            fetch('/trigger-weather-analysis/')
                .then(response => response.json())
                .then(data => {
                    checkWeatherStatus(data.task_id, progressInterval);
                });
        });
        
        function checkWeatherStatus(taskId, progressInterval) {
            fetch(`/check-task/${taskId}/`)
                .then(response => response.json())
                .then(data => {
                    console.log('Weather task check response:', data);  // Debug print
                    if (data.status === 'SUCCESS') {
                        clearInterval(progressInterval);
                        
                        const progressBar = document.getElementById('weatherProgressBar');
                        progressBar.style.width = '100%';
                        progressBar.textContent = 'Complete!';
                        progressBar.setAttribute('aria-valuenow', 100);
                        
                        document.getElementById('weatherWarning').style.display = 'none';
                        
                        setTimeout(() => {
                            document.getElementById('weatherLoadingText').textContent = 'Analysis complete!';
                            document.getElementById('weatherResults').style.display = 'block';
                            
                            // Hide progress after delay (optional)
                            setTimeout(() => {
                                document.getElementById('weatherAnalysisProgress').style.display = 'none';
                            }, 3000);
                        }, 500);
                        
                        // Display the weather analysis results
                        displayWeatherResults(data.result);
                    } else if (data.status === 'FAILURE') {
                        clearInterval(progressInterval);
                        document.getElementById('weatherWarning').style.display = 'none';
                        document.getElementById('weatherLoadingText').textContent = 'Weather analysis failed. Please try again.';
                        
                        const progressBar = document.getElementById('weatherProgressBar');
                        progressBar.style.width = '100%';
                        progressBar.textContent = 'Failed';
                        progressBar.classList.add('bg-danger');
                    } else {
                        setTimeout(() => checkWeatherStatus(taskId, progressInterval), 2000); // Check less frequently
                    }
                })
                .catch(error => {
                    console.error('Error checking weather task status:', error);
                    clearInterval(progressInterval);
                    document.getElementById('weatherLoadingText').textContent = 'Error: ' + error.message;
                });
        }
        
        function displayWeatherResults(result) {
            // Display summary statistics
            document.getElementById('totalDays').textContent = result.total_days_analyzed;
            document.getElementById('dataPoints').textContent = result.weather_impact_samples ? result.weather_impact_samples.length : 0;
            
            // Display correlations
            const correlationsList = document.getElementById('correlationsList');
            correlationsList.innerHTML = '';
            
            if (result.correlations) {
                // Sort correlations by absolute value (strongest first)
                // CHANGE HERE: Filter out null and NaN values
                const sortedCorrelations = Object.entries(result.correlations)
                    .filter(([_, value]) => value !== null && !isNaN(value))  // Filter out null or NaN values
                    .sort((a, b) => Math.abs(b[1]) - Math.abs(a[1]));
                
                // Take top 5 correlations
                const topCorrelations = sortedCorrelations.slice(0, 5);
                
                if (topCorrelations.length > 0) {
                    const correlationTable = document.createElement('table');
                    correlationTable.className = 'table table-sm';
                    
                    const thead = document.createElement('thead');
                    thead.innerHTML = '<tr><th>Variables</th><th>Correlation</th></tr>';
                    correlationTable.appendChild(thead);
                    
                    const tbody = document.createElement('tbody');
                    topCorrelations.forEach(([key, value]) => {
                        const row = document.createElement('tr');
                        
                        // Format the key for better readability
                        const formattedKey = key
                            .replace('weather_', '')
                            .replace('_vs_', ' vs ')
                            .replace(/_/g, ' ');
                        
                        // Determine cell color based on correlation strength
                        const cellColor = Math.abs(value) > 0.7 ? 'text-danger' : 
                                        Math.abs(value) > 0.5 ? 'text-warning' : 
                                        Math.abs(value) > 0.3 ? 'text-info' : '';
                        
                        row.innerHTML = `
                            <td>${formattedKey}</td>
                            <td class="${cellColor}">${value.toFixed(3)}</td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    correlationTable.appendChild(tbody);
                    correlationsList.appendChild(correlationTable);
                } else {
                    correlationsList.innerHTML = '<p>No significant correlations found.</p>';
                }
            } else {
                correlationsList.innerHTML = '<p>No correlation data available.</p>';
            }
            
            // Display weather impact samples
            const samplesTable = document.getElementById('weatherSamplesTable').getElementsByTagName('tbody')[0];
            samplesTable.innerHTML = '';
            
            if (result.weather_impact_samples && result.weather_impact_samples.length > 0) {
                result.weather_impact_samples.forEach(sample => {
                    const row = document.createElement('tr');
                    
                    // Get primary weather variable if available
                    let weatherImpact = 'Data not available';
                    if (sample.weather) {
                        // Check for the weather_condition field first
                        if (sample.weather.weather_condition) {
                            const tempC = sample.weather.temperature_2m_C;
                            const tempStr = tempC !== null && !isNaN(tempC) ? `${tempC.toFixed(1)}°C` : '';
                            weatherImpact = `${sample.weather.weather_condition}${tempStr ? ` at ${tempStr}` : ''}`;
                        }
                        // If no weather_condition, use temperature and/or precipitation
                        else {
                            const tempVar = Object.entries(sample.weather).find(([key]) => 
                                key.includes('temperature') || key.includes('temp') || key === 't2m');
                            const precipVar = Object.entries(sample.weather).find(([key]) => 
                                key.includes('precipitation') || key.includes('precip') || key === 'tp');
                            
                            let conditionParts = [];
                            
                            if (tempVar && tempVar[1] !== null && !isNaN(tempVar[1])) {
                                conditionParts.push(`${tempVar[1].toFixed(1)}°C`);
                            }
                            
                            if (precipVar && precipVar[1] !== null && !isNaN(precipVar[1])) {
                                const precipAmount = precipVar[1];
                                let precipDesc = '';
                                
                                if (precipAmount > 5) precipDesc = 'Heavy Rain';
                                else if (precipAmount > 1) precipDesc = 'Moderate Rain';
                                else if (precipAmount > 0.2) precipDesc = 'Light Rain';
                                else if (precipAmount > 0) precipDesc = 'Drizzle';
                                
                                if (precipDesc) {
                                    conditionParts.push(precipDesc);
                                }
                            }
                            
                            weatherImpact = conditionParts.length > 0 ? conditionParts.join(', ') : 'Weather data unavailable';
                        }
                    }
                    
                    // CHANGE HERE: Add safety checks for taxi data values
                    const rideCount = sample.taxi && sample.taxi.ride_count !== null && !isNaN(sample.taxi.ride_count) ? 
                        sample.taxi.ride_count : 'N/A';
                    
                    const avgFare = sample.taxi && sample.taxi.avg_fare !== null && !isNaN(sample.taxi.avg_fare) ? 
                        `$${sample.taxi.avg_fare.toFixed(2)}` : 'N/A';
                    
                    row.innerHTML = `
                        <td>${sample.year}-${sample.month}-${sample.day}</td>
                        <td>${sample.hour}:00</td>
                        <td>${rideCount}</td>
                        <td>${avgFare}</td>
                        <td>${weatherImpact}</td>
                    `;
                    samplesTable.appendChild(row);
                });
            } else {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5" class="text-center">No weather impact samples available.</td>';
                samplesTable.appendChild(row);
            }
        }
        </script>
    </body>
</html>