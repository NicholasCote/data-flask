<!DOCTYPE html>
<html>
    <title>Temperature Visualization | NSF NCAR Stratus & GLADE UI</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'style.css' %}" type="text/css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/e08b5a6906.js" crossorigin="anonymous"></script>
    <body>
        <div id="nav">
            {% include 'navbar.html' %}
        </div>
        <br>
        <div class="container mt-5">
            <h2>2-meter Temperature Visualization</h2>
            
            <!-- Input Form -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    Customize Your Temperature Analysis
                </div>
                <div class="card-body">
                    <form id="tempAnalysisForm">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="zipCode" class="form-label">Zip Code</label>
                                <input type="text" class="form-control" id="zipCode" placeholder="Enter 5-digit US zip code" 
                                    pattern="[0-9]{5}" title="Please enter a valid 5-digit US zip code" required>
                                <div class="form-text">Example: 82001 (Cheyenne, WY)</div>
                            </div>
                            <div class="col-md-8">
                                <label for="locationDetails" class="form-label">Location Details</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="locationName" readonly>
                                    <button class="btn btn-outline-secondary" type="button" id="locationInfoBtn" 
                                        data-bs-toggle="popover" data-bs-placement="top" 
                                        title="Location Information" data-bs-content="Loading location details...">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                </div>
                                <div class="form-text">Auto-populated based on zip code</div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="startDate" class="form-label">Start Date</label>
                                <input type="month" class="form-control" id="startDate" min="2021-01" max="2022-12" value="2021-01" required>
                            </div>
                            <div class="col-md-6">
                                <label for="endDate" class="form-label">End Date</label>
                                <input type="month" class="form-control" id="endDate" min="2021-01" max="2022-12" value="2021-02" required>
                            </div>
                        </div>
                        
                        <div class="text-end">
                            <button type="button" id="tempAnalyzeBtn" class="btn btn-primary">
                                <i class="fas fa-temperature-high"></i> Generate Temperature Visualization
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="alert alert-warning" id="tempWarning" style="display: none;">
                <strong>Note:</strong> GLADE data processing is computationally intensive and may take several minutes to complete. Please be patient while we process your request.
            </div>
            
            <!-- Active Analysis Section -->
            <div class="mt-4">
                <h3>Active Analysis Tasks</h3>
                
                <!-- Progress bar for temperature analysis -->
                <div id="tempAnalysisProgress" style="display: none;" class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Temperature Analysis</h5>
                        <div class="progress">
                            <div id="tempProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" 
                                style="width: 0%">0%</div>
                        </div>
                        <p class="text-muted mt-2" id="tempLoadingText">Analysis in progress...</p>
                    </div>
                </div>
            </div>
            
            <!-- Results Section -->
            <div class="mt-4">
                <h3>Analysis Results</h3>
                
                <!-- Temperature Visualization Results -->
                <div id="tempResults" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            2-meter Temperature for <span id="resultLocationName">Cheyenne, Wyoming</span>
                        </div>
                        <div class="card-body text-center">
                            <img id="tempResultImage" src="" alt="Temperature Visualization" class="img-fluid">
                        </div>
                        <div class="card-footer">
                            <p><small>Data source: ERA5 reanalysis data from the Research Data Archive</small></p>
                            <p><small>Time period: <span id="resultTimeRange">January 2021 - February 2021</span></small></p>
                            <div id="resultMetadata"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Error display -->
                <div id="tempError" class="mt-4 alert alert-danger" style="display: none;">
                    <strong>Error:</strong> <span id="tempErrorMessage"></span>
                </div>
            </div>
        </div>
        
        <script>
            // Initialize popovers
            var locationPopover = null;
            
            document.addEventListener('DOMContentLoaded', function() {
                // Initialize the popover for location information
                locationPopover = new bootstrap.Popover(document.getElementById('locationInfoBtn'), {
                    html: true,
                    trigger: 'focus'
                });
            });
            
            // Lookup zip code when entered
            document.getElementById('zipCode').addEventListener('change', function() {
                const zipCode = this.value;
                if (/^\d{5}$/.test(zipCode)) {
                    // Make sure to use the correct URL pattern
                    fetch(`/lookup-zipcode/${zipCode}/`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log("ZIP code lookup response:", data); // Add this to debug
                            
                            if (data.success) {
                                // Update the location name field - add fallback for undefined values
                                document.getElementById('locationName').value = data.display_name || `${data.city || 'Unknown'}, ${data.state || 'Unknown'}`;
                                
                                // Update the popover content with detailed location information
                                const popoverContent = `
                                    <div class="location-details">
                                        <p><strong>City:</strong> ${data.city || 'Unknown'}</p>
                                        ${data.county ? `<p><strong>County:</strong> ${data.county}</p>` : ''}
                                        <p><strong>State:</strong> ${data.state || 'Unknown'}</p>
                                        <p><strong>Coordinates:</strong> ${(data.lat || 0).toFixed(4)}, ${((data.lon > 180 ? data.lon - 360 : data.lon) || 0).toFixed(4)}</p>
                                    </div>
                                `;
                                
                                // Update the popover content
                                const popoverEl = document.getElementById('locationInfoBtn');
                                popoverEl.setAttribute('data-bs-content', popoverContent);
                                
                                // Refresh the popover if it's currently shown
                                if (popoverEl.getAttribute('aria-describedby')) {
                                    locationPopover.dispose();
                                    locationPopover = new bootstrap.Popover(popoverEl, {
                                        html: true,
                                        trigger: 'focus'
                                    });
                                    locationPopover.show();
                                }
                            } else {
                                document.getElementById('locationName').value = 'Using default location';
                                document.getElementById('locationInfoBtn').setAttribute('data-bs-content', 
                                    'Could not find detailed information for this ZIP code. Using default location.');
                            }
                        })
                        .catch(error => {
                            console.error('Error looking up zip code:', error);
                            document.getElementById('locationName').value = 'Using default location (API error)';
                            document.getElementById('locationInfoBtn').setAttribute('data-bs-content', 
                                'Error retrieving location information. Using default location.');
                        });
                }
            });
            
            // Validate date range
            document.getElementById('endDate').addEventListener('change', function() {
                const startDate = document.getElementById('startDate').value;
                const endDate = this.value;
                
                if (startDate > endDate) {
                    alert('End date must be after start date');
                    this.value = startDate;
                }
            });
        
            document.getElementById('tempAnalyzeBtn').addEventListener('click', function() {
                // Form validation
                const zipCode = document.getElementById('zipCode').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const locationName = document.getElementById('locationName').value;
                
                if (!zipCode || !startDate || !endDate) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                if (!/^\d{5}$/.test(zipCode)) {
                    alert('Please enter a valid 5-digit US zip code');
                    return;
                }
                
                // Update result location name
                document.getElementById('resultLocationName').textContent = locationName || 'Selected Location';
                document.getElementById('resultTimeRange').textContent = formatDateRange(startDate, endDate);
                
                // Reset displays
                document.getElementById('tempAnalysisProgress').style.display = 'block';
                document.getElementById('tempWarning').style.display = 'block';
                document.getElementById('tempResults').style.display = 'none';
                document.getElementById('tempError').style.display = 'none';
                
                const progressBar = document.getElementById('tempProgressBar');
                const loadingText = document.getElementById('tempLoadingText');
                
                // Reset progress bar
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
                progressBar.setAttribute('aria-valuenow', 0);
                progressBar.classList.remove('bg-danger');
                progressBar.classList.add('progress-bar-animated');
                
                loadingText.textContent = 'Starting analysis...';
                
                // Start the task with custom parameters
                fetch('/trigger-temperature-analysis/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        zipCode: zipCode,
                        startDate: startDate,
                        endDate: endDate
                    })
                })
                .then(response => response.json())
                .then(data => {
                    const taskId = data.task_id;
                    checkTaskStatus(taskId);
                })
                .catch(error => {
                    console.error('Error starting task:', error);
                    showError('Failed to start analysis: ' + error.message);
                });
            });
            
            function getCSRFToken() {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'csrftoken') {
                        return value;
                    }
                }
                return null;
            }
            
            function formatDateRange(startDate, endDate) {
                const formatMonth = (dateStr) => {
                    const date = new Date(dateStr + '-01');
                    return date.toLocaleString('default', { month: 'long', year: 'numeric' });
                };
                
                return `${formatMonth(startDate)} - ${formatMonth(endDate)}`;
            }
            
            function checkTaskStatus(taskId) {
                fetch(`/check-temperature-task/${taskId}/`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Task status:', data);
                        updateProgressUI(data);
                        
                        if (data.status === 'SUCCESS') {
                            // Task completed successfully
                            taskCompleted(data.result);
                        } else if (data.status === 'FAILURE') {
                            // Task failed
                            taskFailed(data.error || 'Unknown error occurred');
                        } else {
                            // Task still running, check again after a delay
                            setTimeout(() => checkTaskStatus(taskId), 1000);
                        }
                    })
                    .catch(error => {
                        console.error('Error checking task status:', error);
                        showError('Error checking task status: ' + error.message);
                    });
            }
            
            function updateProgressUI(data) {
                const progressBar = document.getElementById('tempProgressBar');
                const loadingText = document.getElementById('tempLoadingText');
                
                if (data.progress !== undefined) {
                    const progress = data.progress;
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = progress + '%';
                    progressBar.setAttribute('aria-valuenow', progress);
                }
                
                if (data.status_message) {
                    loadingText.textContent = data.status_message;
                }
            }
            
            function taskCompleted(result) {
                // Update progress UI
                const progressBar = document.getElementById('tempProgressBar');
                progressBar.style.width = '100%';
                progressBar.textContent = 'Complete!';
                progressBar.setAttribute('aria-valuenow', 100);
                progressBar.classList.remove('progress-bar-animated');
                
                document.getElementById('tempLoadingText').textContent = 'Analysis complete!';
                
                // Hide warning
                document.getElementById('tempWarning').style.display = 'none';
                
                // Show result
                const imgElement = document.getElementById('tempResultImage');
                imgElement.src = result;  // data:image/png;base64,... URL
                
                // Update result location with detailed information
                const locationName = document.getElementById('locationName').value;
                document.getElementById('resultLocationName').textContent = locationName;
                
                // Format the time range
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                document.getElementById('resultTimeRange').textContent = formatDateRange(startDate, endDate);
                
                // Add metadata to the results card
                const metadataDiv = document.getElementById('resultMetadata');
                if (metadataDiv) {
                    const zipCode = document.getElementById('zipCode').value;
                    metadataDiv.innerHTML = `
                        <p><small>ZIP Code: ${zipCode}</small></p>
                        <p><small>Location: ${locationName}</small></p>
                    `;
                }
                
                // Make sure the results div is visible
                document.getElementById('tempResults').style.display = 'block';
                
                // Hide progress after delay (optional)
                setTimeout(() => {
                    document.getElementById('tempAnalysisProgress').style.display = 'none';
                }, 3000);
            }
            
            function taskFailed(errorMessage) {
                // Update progress UI
                const progressBar = document.getElementById('tempProgressBar');
                progressBar.style.width = '100%';
                progressBar.textContent = 'Failed';
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-danger');
                
                document.getElementById('tempLoadingText').textContent = 'Analysis failed!';
                
                // Hide warning
                document.getElementById('tempWarning').style.display = 'none';
                
                // Show error
                showError(errorMessage);
            }
            
            function showError(errorMessage) {
                const errorDiv = document.getElementById('tempError');
                const errorMessageSpan = document.getElementById('tempErrorMessage');
                
                errorMessageSpan.textContent = errorMessage;
                errorDiv.style.display = 'block';
            }
        </script>
    </body>
</html>