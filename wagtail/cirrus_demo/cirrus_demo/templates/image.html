<!DOCTYPE html>
<html>
    <title>Home | NSF NCAR Stratus & GLADE UI</title>
        <link rel="canonical" href="{% url 'home' %}"/>
        <meta property="og:title" content="Home | NCAR Stratus UI"/>
        <meta property="og:url" content="{% url 'home' %}"/>
        <meta property="og:site_name" content="ncar_stratus_ui"/>
        <meta property="og:type" content="website"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}
    <link rel="stylesheet" href="{% static 'style.css' %}" type="text/css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/e08b5a6906.js" crossorigin="anonymous"></script>
    <body>
        <div id="nav">
            {% include 'navbar.html' %}
        </div>
        <br>
        <div class="container mt-5">
            <h2>Wind Speed Visualization</h2>
            
            <!-- Input Form -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    Customize Your Wind Speed Analysis
                </div>
                <div class="card-body">
                    <form id="windAnalysisForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="zipCode" class="form-label">Zip Code</label>
                                <input type="text" class="form-control" id="zipCode" placeholder="Enter 5-digit US zip code" 
                                    pattern="[0-9]{5}" title="Please enter a valid 5-digit US zip code" required>
                                <div class="form-text">Example: 82001 (Cheyenne, WY)</div>
                            </div>
                            <div class="col-md-6">
                                <label for="locationName" class="form-label">Location Name</label>
                                <input type="text" class="form-control" id="locationName" readonly>
                                <div class="form-text">Auto-populated based on zip code</div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="startDate" class="form-label">Start Date</label>
                                <input type="month" class="form-control" id="startDate" min="2021-01" max="2022-12" value="2021-01" required>
                            </div>
                            <div class="col-md-6">
                                <label for="endDate" class="form-label">End Date</label>
                                <input type="month" class="form-control" id="endDate" min="2021-01" max="2022-12" value="2021-02" required>
                            </div>
                        </div>
                        
                        <div class="text-end">
                            <button type="button" id="gladeAnalyzeBtn" class="btn btn-primary">
                                <i class="fas fa-wind"></i> Generate Wind Visualization
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="alert alert-warning" id="gladeWarning" style="display: none;">
                <strong>Note:</strong> GLADE data processing is computationally intensive and may take several minutes to complete. Please be patient while we process your request.
            </div>
            
            <!-- Active Analysis Section -->
            <div class="mt-4">
                <h3>Active Analysis Tasks</h3>
                
                <!-- Progress bar for GLADE analysis -->
                <div id="gladeAnalysisProgress" style="display: none;" class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">GLADE Wind Analysis</h5>
                        <div class="progress">
                            <div id="gladeProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" 
                                style="width: 0%">0%</div>
                        </div>
                        <p class="text-muted mt-2" id="gladeLoadingText">Analysis in progress...</p>
                    </div>
                </div>
            </div>
            
            <!-- Results Section -->
            <div class="mt-4">
                <h3>Analysis Results</h3>
                
                <!-- GLADE Visualization Results -->
                <div id="gladeResults" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            Wind Speed Visualization for <span id="resultLocationName">Cheyenne, Wyoming</span>
                        </div>
                        <div class="card-body text-center">
                            <img id="gladeResultImage" src="" alt="Wind Speed Visualization" class="img-fluid">
                        </div>
                        <div class="card-footer">
                            <p><small>Data source: ERA5 reanalysis data from the Research Data Archive</small></p>
                            <p><small>Time period: <span id="resultTimeRange">January 2021 - February 2021</span></small></p>
                        </div>
                    </div>
                </div>
                
                <!-- Error display -->
                <div id="gladeError" class="mt-4 alert alert-danger" style="display: none;">
                    <strong>Error:</strong> <span id="gladeErrorMessage"></span>
                </div>
            </div>
        </div>
        <script>
            // Lookup zip code when entered
            document.getElementById('zipCode').addEventListener('change', function() {
                const zipCode = this.value;
                if (/^\d{5}$/.test(zipCode)) {
                    // Make sure to use the correct URL pattern with app URL prefix if needed
                    // If your Django app is mounted at a sub-path, prepend it here
                    fetch(`/lookup-zipcode/${zipCode}/`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                document.getElementById('locationName').value = `${data.city}, ${data.state}`;
                            } else {
                                document.getElementById('locationName').value = 'Using default location';
                            }
                        })
                        .catch(error => {
                            console.error('Error looking up zip code:', error);
                            document.getElementById('locationName').value = 'Using default location (API error)';
                        });
                }
            });
            
            // Validate date range
            document.getElementById('endDate').addEventListener('change', function() {
                const startDate = document.getElementById('startDate').value;
                const endDate = this.value;
                
                if (startDate > endDate) {
                    alert('End date must be after start date');
                    this.value = startDate;
                }
            });
        
            document.getElementById('gladeAnalyzeBtn').addEventListener('click', function() {
                // Form validation
                const zipCode = document.getElementById('zipCode').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const locationName = document.getElementById('locationName').value;
                
                if (!zipCode || !startDate || !endDate) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                if (!/^\d{5}$/.test(zipCode)) {
                    alert('Please enter a valid 5-digit US zip code');
                    return;
                }
                
                // Update result location name
                document.getElementById('resultLocationName').textContent = locationName || 'Selected Location';
                document.getElementById('resultTimeRange').textContent = formatDateRange(startDate, endDate);
                
                // Reset displays
                document.getElementById('gladeAnalysisProgress').style.display = 'block';
                document.getElementById('gladeWarning').style.display = 'block';
                document.getElementById('gladeResults').style.display = 'none';
                document.getElementById('gladeError').style.display = 'none';
                
                const progressBar = document.getElementById('gladeProgressBar');
                const loadingText = document.getElementById('gladeLoadingText');
                
                // Reset progress bar
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
                progressBar.setAttribute('aria-valuenow', 0);
                progressBar.classList.remove('bg-danger');
                progressBar.classList.add('progress-bar-animated');
                
                loadingText.textContent = 'Starting analysis...';
                
                // Start the task with custom parameters
                fetch('/trigger-glade-analysis/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        zipCode: zipCode,
                        startDate: startDate,
                        endDate: endDate
                    })
                })
                .then(response => response.json())
                .then(data => {
                    const taskId = data.task_id;
                    checkTaskStatus(taskId);
                })
                .catch(error => {
                    console.error('Error starting task:', error);
                    showError('Failed to start analysis: ' + error.message);
                });
            });
            
            function getCSRFToken() {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'csrftoken') {
                        return value;
                    }
                }
                return null;
            }
            
            function formatDateRange(startDate, endDate) {
                const formatMonth = (dateStr) => {
                    const date = new Date(dateStr + '-01');
                    return date.toLocaleString('default', { month: 'long', year: 'numeric' });
                };
                
                return `${formatMonth(startDate)} - ${formatMonth(endDate)}`;
            }
            
            function checkTaskStatus(taskId) {
                fetch(`/check-glade-task/${taskId}/`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Task status:', data);
                        updateProgressUI(data);
                        
                        if (data.status === 'SUCCESS') {
                            // Task completed successfully
                            taskCompleted(data.result);
                        } else if (data.status === 'FAILURE') {
                            // Task failed
                            taskFailed(data.error || 'Unknown error occurred');
                        } else {
                            // Task still running, check again after a delay
                            setTimeout(() => checkTaskStatus(taskId), 1000);
                        }
                    })
                    .catch(error => {
                        console.error('Error checking task status:', error);
                        showError('Error checking task status: ' + error.message);
                    });
            }
            
            function updateProgressUI(data) {
                const progressBar = document.getElementById('gladeProgressBar');
                const loadingText = document.getElementById('gladeLoadingText');
                
                if (data.progress !== undefined) {
                    const progress = data.progress;
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = progress + '%';
                    progressBar.setAttribute('aria-valuenow', progress);
                }
                
                if (data.status_message) {
                    loadingText.textContent = data.status_message;
                }
            }
            
            function taskCompleted(result) {
                // Update progress UI
                const progressBar = document.getElementById('gladeProgressBar');
                progressBar.style.width = '100%';
                progressBar.textContent = 'Complete!';
                progressBar.setAttribute('aria-valuenow', 100);
                progressBar.classList.remove('progress-bar-animated');
                
                document.getElementById('gladeLoadingText').textContent = 'Analysis complete!';
                
                // Hide warning
                document.getElementById('gladeWarning').style.display = 'none';
                
                // Show result
                const imgElement = document.getElementById('gladeResultImage');
                imgElement.src = result;  // data:image/png;base64,... URL
                
                // Make sure the results div is visible
                document.getElementById('gladeResults').style.display = 'block';
                
                // Hide progress after delay (optional)
                setTimeout(() => {
                    document.getElementById('gladeAnalysisProgress').style.display = 'none';
                }, 3000);
            }
            
            function taskFailed(errorMessage) {
                // Update progress UI
                const progressBar = document.getElementById('gladeProgressBar');
                progressBar.style.width = '100%';
                progressBar.textContent = 'Failed';
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-danger');
                
                document.getElementById('gladeLoadingText').textContent = 'Analysis failed!';
                
                // Hide warning
                document.getElementById('gladeWarning').style.display = 'none';
                
                // Show error
                showError(errorMessage);
            }
            
            function showError(errorMessage) {
                const errorDiv = document.getElementById('gladeError');
                const errorMessageSpan = document.getElementById('gladeErrorMessage');
                
                errorMessageSpan.textContent = errorMessage;
                errorDiv.style.display = 'block';
            }
        </script>
    </body>
</html>