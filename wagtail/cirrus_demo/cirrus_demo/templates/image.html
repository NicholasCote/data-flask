<!DOCTYPE html>
<html>
    <title>Home | NSF NCAR Stratus & GLADE UI</title>
        <link rel="canonical" href="{% url 'home' %}"/>
        <meta property="og:title" content="Home | NCAR Stratus UI"/>
        <meta property="og:url" content="{% url 'home' %}"/>
        <meta property="og:site_name" content="ncar_stratus_ui"/>
        <meta property="og:type" content="website"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}
    <link rel="stylesheet" href="{% static 'style.css' %}" type="text/css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/e08b5a6906.js" crossorigin="anonymous"></script>
    <body>
        <div id="nav">
            {% include 'navbar.html' %}
        </div>
        <br>
        <div class="container mt-5">
            <h2>Wind Speed Visualization</h2>
            <div class="row mb-4">
                <div class="col-md-4">
                    <button id="gladeAnalyzeBtn" class="btn btn-primary btn-block">
                        <i class="fas fa-wind"></i> Generate Wind Visualization
                    </button>
                </div>
            </div>
            
            <div class="alert alert-warning" id="gladeWarning" style="display: none;">
                <strong>Note:</strong> GLADE data processing is computationally intensive and may take several minutes to complete. This visualization shows hourly average wind speeds for Cheyenne, Wyoming.
            </div>
            
            <!-- Active Analysis Section -->
            <div class="mt-4">
                <h3>Active Analysis Tasks</h3>
                
                <!-- Progress bar for GLADE analysis -->
                <div id="gladeAnalysisProgress" style="display: none;" class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">GLADE Wind Analysis</h5>
                        <div class="progress">
                            <div id="gladeProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" 
                                style="width: 0%">0%</div>
                        </div>
                        <p class="text-muted mt-2" id="gladeLoadingText">Analysis in progress...</p>
                    </div>
                </div>
            </div>
            
            <!-- Results Section -->
            <div class="mt-4">
                <h3>Analysis Results</h3>
                
                <!-- GLADE Visualization Results -->
                <div id="gladeResults" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            Wind Speed Visualization for Cheyenne, Wyoming
                        </div>
                        <div class="card-body text-center">
                            <img id="gladeResultImage" src="" alt="Wind Speed Visualization" class="img-fluid">
                        </div>
                        <div class="card-footer">
                            <p><small>Data source: ERA5 reanalysis data from the Research Data Archive</small></p>
                        </div>
                    </div>
                </div>
                
                <!-- Error display -->
                <div id="gladeError" class="mt-4 alert alert-danger" style="display: none;">
                    <strong>Error:</strong> <span id="gladeErrorMessage"></span>
                </div>
            </div>
        </div>
        <div class="bigbubble">
            
        <h2>This image is generated by running the following Python code</h2>

        <pre class="pre-scrollable"><code>
            import xarray as xr
            import numpy as np
            from matplotlib import pyplot as plt

            import os

            def get_glade_picture():
                def get_dataset(filepath_pattern, use_grib, parallel):
                    """ Given a file pattern specification and a file format type, return an xarray dataset 
                        containing data from all matching files.   
                        
                        `filepath_pattern` must specify a full directory path.  Wildcards may be included to match
                        many subdirectories or groups of files.  Wildcard syntax follows bash shell conventions for
                        greater flexibility.
                        
                        If `parallel = True`, use an existing Dask cluster to open data files.
                    """
                    # If reading GRIB data, disable saving a GRIB index file to the data directory.
                    if use_grib:
                        filename_extension = '.grb'
                        backend_kwargs = {'indexpath': ''}
                    else:
                        filename_extension = '.nc'    
                        backend_kwargs = None
                        
                    full_pattern = filepath_pattern + filename_extension
                    
                    # Allow bash-style syntax for file patterns
                    file_listing = os.popen(f"/bin/bash -c 'ls {full_pattern}'").read()
                    
                    # Split the output into lines and ignore empty lines
                    file_list = file_listing.split('\n')
                    file_list = [filename for filename in file_list if len(filename) > 0]

                    # Verify there is at least one matching file
                    if len(file_list) == 0:
                        raise ValueError(f'No files match the pattern {full_pattern}')
                        
                    ds = xr.open_mfdataset(file_list, parallel=parallel, backend_kwargs=backend_kwargs) 
                    return ds

                def get_point_array(dataset, latitude, longitude, varname=None):
                    """ Extract and return a DataArray object associated with some lat/lon location.
                    A DataArray object is an array of time series values, along with associated metadata.
                    
                    'dataset' is an xarray dataset
                    
                    'latitude' is a scalar in the range of the dataset's latitude values.
                        
                    'longitude' is a scalar in the range of the dataset's longitude values.

                    If 'varname' is provided, retrieve values from this data variable.  Otherwise, 
                        return values from the first data variable in the dataset.
                    """
                    # Assert latitude value is in the dataset range
                    assert(latitude >= np.min(dataset.coords['latitude'].values))
                    assert(latitude <= np.max(dataset.coords['latitude'].values))
                    
                    # Assert longitude value is in the dataset range
                    assert(longitude >= np.min(dataset.coords['longitude'].values))
                    assert(longitude <= np.max(dataset.coords['longitude'].values))
                    
                    # If a data variable name is not provided, use the first data variable.
                    if not varname:
                        data_vars = list(dataset.data_vars.keys())
                        varname = data_vars[0]
                        
                    point_array = dataset[varname].sel(latitude=latitude, longitude=longitude, method='nearest')
                    return point_array

                def wind_speed(u, v, units=None):
                    """Compute the wind speed from u and v-component numpy arrays.
                    If units is 'mph', convert from "meters per second" to "miles per hour".
                    """
                    speed = np.hypot(u, v)
                    if units == 'mph':
                        speed = 2.369 * speed
                    return speed

                def plot_winds(u_values, v_values, time_values):
                    """ Compute wind speed values and plot them on a line plot.
                    """
                    winds = wind_speed(u_values, v_values, units='mph')
                    fig, ax = plt.subplots(1, 1, figsize=(10, 10))
                    ax.plot(time_values, winds, color='r')
                    ax.set_title('Hourly Average Wind Speeds for Cheyenne, Wyoming')
                    ax.set_ylabel('Miles Per Hour')
                    return fig

                MAX_WORKERS = 4

                def get_local_cluster():
                    """ Create cluster using the Jupyter server's resources
                    """
                    from distributed import LocalCluster
                    cluster = LocalCluster()    

                    cluster.scale(MAX_WORKERS)
                    return cluster

                # Obtain dask cluster in one of three ways

                cluster = get_local_cluster()

                # Connect to cluster
                from distributed import Client
                client = Client(cluster)

                # Pause notebook execution until some workers have been allocated.
                min_workers = 2
                client.wait_for_workers(min_workers)

                # This subdirectory contains surface analysis data on a 0.25 degree global grid
                data_dir = '/glade/campaign/collections/rda/data/ds633.0/e5.oper.an.sfc/'

                # This bash-style pattern will match data for 2021 and 2022.
                year_month_pattern = '202{1,2}*/'

                data_spec = data_dir + year_month_pattern

                # These filename patterns refer to u- and v-components of winds at 10 meters above the land surface.
                filename_pattern_u = 'e5.oper.an.sfc.228_131_u10n.ll025sc.*'
                filename_pattern_v = 'e5.oper.an.sfc.228_132_v10n.ll025sc.*'  

                ds_u = get_dataset(data_spec + filename_pattern_u, False, parallel=True)
                ds_v = get_dataset(data_spec + filename_pattern_v, False, parallel=True)

                var_u = 'U10N'
                var_v = 'V10N'

                # Select data for a specific geographic location (Cheyenne, Wyoming).
                # Note that dataset longitude values are in the range [0, 360]; click the disk icon to the right of 
                #   "longitude" above to verify.
                # We convert from longitude values provided by Google in the range [-180, 180] using subtraction.

                cheyenne = {'lat': 41.14, 'lon': 360 - 104.82}

                city = cheyenne

                # Select the nearest grid cell to our lat/lon location.
                u = get_point_array(ds_u, city['lat'], city['lon'], var_u)
                v = get_point_array(ds_v, city['lat'], city['lon'], var_v)

                # Actually load the data into memory.
                u_values = u.values
                v_values = v.values

                figure = plot_winds(u_values, v_values, ds_u.time)

                cur_dir = os.getcwd()
                plotfile = cur_dir + '/app/static/glade_data_access.png'
                figure.savefig(plotfile, dpi=100)

                cluster.close()

                return '/static/glade_data_access.png'
        </code></pre>
    </div>
    <script>
        document.getElementById('gladeAnalyzeBtn').addEventListener('click', function() {
            // Reset displays
            document.getElementById('gladeAnalysisProgress').style.display = 'block';
            document.getElementById('gladeWarning').style.display = 'block';
            document.getElementById('gladeResults').style.display = 'none';
            document.getElementById('gladeError').style.display = 'none';
            
            const progressBar = document.getElementById('gladeProgressBar');
            const loadingText = document.getElementById('gladeLoadingText');
            
            // Reset progress bar
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            progressBar.setAttribute('aria-valuenow', 0);
            progressBar.classList.remove('bg-danger');
            progressBar.classList.add('progress-bar-animated');
            
            loadingText.textContent = 'Starting analysis...';
            
            // Start the task
            fetch('/trigger-glade-analysis/')
                .then(response => response.json())
                .then(data => {
                    const taskId = data.task_id;
                    checkTaskStatus(taskId);
                })
                .catch(error => {
                    console.error('Error starting task:', error);
                    showError('Failed to start analysis: ' + error.message);
                });
        });
        
        function checkTaskStatus(taskId) {
            fetch(`/check-glade-task/${taskId}/`)
                .then(response => response.json())
                .then(data => {
                    console.log('Task status:', data);
                    updateProgressUI(data);
                    
                    if (data.status === 'SUCCESS') {
                        // Task completed successfully
                        taskCompleted(data.result);
                    } else if (data.status === 'FAILURE') {
                        // Task failed
                        taskFailed(data.error || 'Unknown error occurred');
                    } else {
                        // Task still running, check again after a delay
                        setTimeout(() => checkTaskStatus(taskId), 1000);
                    }
                })
                .catch(error => {
                    console.error('Error checking task status:', error);
                    showError('Error checking task status: ' + error.message);
                });
        }
        
        function updateProgressUI(data) {
            const progressBar = document.getElementById('gladeProgressBar');
            const loadingText = document.getElementById('gladeLoadingText');
            
            if (data.progress !== undefined) {
                const progress = data.progress;
                progressBar.style.width = progress + '%';
                progressBar.textContent = progress + '%';
                progressBar.setAttribute('aria-valuenow', progress);
            }
            
            if (data.status_message) {
                loadingText.textContent = data.status_message;
            }
        }
        
        function taskCompleted(result) {
            // Update progress UI
            const progressBar = document.getElementById('gladeProgressBar');
            progressBar.style.width = '100%';
            progressBar.textContent = 'Complete!';
            progressBar.setAttribute('aria-valuenow', 100);
            progressBar.classList.remove('progress-bar-animated');
            
            document.getElementById('gladeLoadingText').textContent = 'Analysis complete!';
            
            // Hide warning
            document.getElementById('gladeWarning').style.display = 'none';
            
            // Show result - make sure we're setting the correct path
            console.log('Setting image path to:', result); // Debug log
            const imgElement = document.getElementById('gladeResultImage');
            imgElement.src = result;
            
            // Make sure the results div is visible
            document.getElementById('gladeResults').style.display = 'block';
            
            // Hide progress after delay (optional)
            setTimeout(() => {
                document.getElementById('gladeAnalysisProgress').style.display = 'none';
            }, 3000);
        }
        
        function taskFailed(errorMessage) {
            // Update progress UI
            const progressBar = document.getElementById('gladeProgressBar');
            progressBar.style.width = '100%';
            progressBar.textContent = 'Failed';
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.add('bg-danger');
            
            document.getElementById('gladeLoadingText').textContent = 'Analysis failed!';
            
            // Hide warning
            document.getElementById('gladeWarning').style.display = 'none';
            
            // Show error
            showError(errorMessage);
        }
        
        function showError(errorMessage) {
            const errorDiv = document.getElementById('gladeError');
            const errorMessageSpan = document.getElementById('gladeErrorMessage');
            
            errorMessageSpan.textContent = errorMessage;
            errorDiv.style.display = 'block';
        }
        </script>
    </body>
</html>